name: Simple RDP Server

on:
  workflow_dispatch:

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP and Configure
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        
        # Open ports
        $ports = @(3389, 5555, 7777, 8888, 9999)
        foreach ($port in $ports) {
            netsh advfirewall firewall add rule name="RDP-$port" dir=in action=allow protocol=TCP localport=$port
        }
        
        # Create user
        $password = "!QA2ws3ed"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction SilentlyContinue
        Set-LocalUser -Name "RDP" -Password $securePass -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
        
        Restart-Service -Name TermService -Force

    - name: Display Connection Info
      run: |
        $ip = (Test-Connection -ComputerName (hostname) -Count 1).IPV4Address.IPAddressToString
        Write-Host "=========================================="
        Write-Host "RDP SERVER READY"
        Write-Host "=========================================="
        Write-Host "IP: $ip"
        Write-Host "Ports: 3389, 5555, 7777, 8888, 9999"
        Write-Host "Username: RDP"
        Write-Host "Password: !QA2ws3ed"
        Write-Host "=========================================="

    - name: Keep Alive
      run: |
        $startTime = Get-Date
        while (((Get-Date) - $startTime).TotalMinutes -lt 350) {
            $remaining = 350 - [math]::Round(((Get-Date) - $startTime).TotalMinutes, 1)
            Write-Host "[$(Get-Date)] RDP Active - Time left: ${remaining}m"
            Start-Sleep -Seconds 60
        }
