name: RDP Server with Clear IP

on:
  workflow_dispatch:

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP and Configure
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        
        # Open ports
        $ports = @(3389, 5555, 7777, 8888, 9999)
        foreach ($port in $ports) {
            netsh advfirewall firewall add rule name="RDP-$port" dir=in action=allow protocol=TCP localport=$port
        }
        
        # Create user
        $password = "!QA2ws3ed"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
        
        Restart-Service -Name TermService -Force

    - name: Get Network Information
      run: |
        # Get local IP
        $localIP = (Test-Connection -ComputerName (hostname) -Count 1).IPV4Address.IPAddressToString
        echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
        
        # Try to get public IP
        try {
            $publicIP = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
            echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
        } catch {
            echo "PUBLIC_IP=Unable to retrieve" >> $env:GITHUB_ENV
        }

    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "ğŸ¯ğŸ¯ğŸ¯ RDP CONNECTION INFORMATION ğŸ¯ğŸ¯ğŸ¯" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host "ğŸ“ LOCAL IP: $env:LOCAL_IP" -ForegroundColor Cyan
        Write-Host "ğŸŒ PUBLIC IP: $env:PUBLIC_IP" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host "ğŸ‘¤ USERNAME: RDP" -ForegroundColor White
        Write-Host "ğŸ”‘ PASSWORD: !QA2ws3ed" -ForegroundColor White
        Write-Host "ğŸšª PORTS: 3389, 5555, 7777, 8888, 9999" -ForegroundColor White
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "ğŸ’¡ CONNECTION EXAMPLES:" -ForegroundColor Magenta
        Write-Host "mstsc /v:$env:LOCAL_IP`:3389" -ForegroundColor White
        Write-Host "mstsc /v:$env:LOCAL_IP`:5555" -ForegroundColor White
        Write-Host "mstsc /v:$env:PUBLIC_IP`:3389" -ForegroundColor White
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host ""

    - name: Keep Server Alive
      run: |
        $counter = 0
        while ($counter -lt 350) {
            Write-Host "[$(Get-Date)] RDP Server is running... (Time elapsed: ${counter}m)" -ForegroundColor Green
            Start-Sleep -Seconds 60
            $counter++
        }
