name: Permanent RDP Server

on:
  workflow_dispatch:

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install Tailscale
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
        Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait
        Start-Sleep -Seconds 10

    - name: Setup Tailscale
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=my-permanent-rdp
        Start-Sleep -Seconds 10
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        $hostname = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json | Select-Object -ExpandProperty Self | Select-Object -ExpandProperty DNSName
        echo "RDP_IP=$ip" >> $env:GITHUB_ENV
        echo "RDP_HOSTNAME=$hostname" >> $env:GITHUB_ENV

    - name: Create Persistent Storage First
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
        New-Item -ItemType Directory -Path "C:\PersistentData" -Force
        New-Item -ItemType Directory -Path "C:\PersistentData\Desktop" -Force
        New-Item -ItemType Directory -Path "C:\PersistentData\Documents" -Force
        New-Item -ItemType Directory -Path "C:\PersistentData\Downloads" -Force
        Write-Host "âœ… Persistent storage created"

    - name: Configure Windows RDP and User
      run: |
        # ØªÙØ¹ÙŠÙ„ RDP ÙÙŠ Ø§Ù„Ø±ÙŠØ¬Ø³ØªØ±ÙŠ
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
        
        # ÙØªØ­ Ø§Ù„Ù…Ù†Ø§ÙØ° ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
        netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389
        netsh advfirewall firewall add rule name="RDP-5555" dir=in action=allow protocol=TCP localport=5555
        netsh advfirewall firewall add rule name="RDP-7777" dir=in action=allow protocol=TCP localport=7777
        netsh advfirewall firewall add rule name="RDP-8888" dir=in action=allow protocol=TCP localport=8888
        netsh advfirewall firewall add rule name="RDP-9999" dir=in action=allow protocol=TCP localport=9999
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… RDP
        net user RDP "Password123!" /add /y
        net localgroup administrators RDP /add
        net localgroup "Remote Desktop Users" RDP /add
        Write-Host "âœ… User RDP created"

    - name: Setup User Profile and Links
      run: |
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†Ø´Ø¦ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        Start-Sleep -Seconds 5
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        New-Item -ItemType Directory -Path "C:\Users\RDP\Desktop" -Force
        New-Item -ItemType Directory -Path "C:\Users\RDP\Documents" -Force
        New-Item -ItemType Directory -Path "C:\Users\RDP\Downloads" -Force
        
        # Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ¯ÙŠÙ…Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰)
        Copy-Item -Path "C:\Users\RDP\Desktop\*" -Destination "C:\PersistentData\Desktop\" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "C:\Users\RDP\Documents\*" -Destination "C:\PersistentData\Documents\" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "C:\Users\RDP\Downloads\*" -Destination "C:\PersistentData\Downloads\" -Recurse -Force -ErrorAction SilentlyContinue
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø±ÙˆØ§Ø¨Ø·
        Remove-Item -Path "C:\Users\RDP\Desktop" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\RDP\Documents" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\RDP\Downloads" -Recurse -Force -ErrorAction SilentlyContinue
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆØ§Ø¨Ø· Ø±Ù…Ø²ÙŠØ©
        cmd /c "mklink /J `"C:\Users\RDP\Desktop`" `"C:\PersistentData\Desktop`""
        cmd /c "mklink /J `"C:\Users\RDP\Documents`" `"C:\PersistentData\Documents`""
        cmd /c "mklink /J `"C:\Users\RDP\Downloads`" `"C:\PersistentData\Downloads`""
        Write-Host "âœ… User profile links created"

    - name: Start RDP Services
      run: |
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© RDP
        Stop-Service -Name "TermService" -Force
        Start-Service -Name "TermService"
        Write-Host "âœ… RDP services started"

    - name: Install Software
      run: |
        # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        winget install --id Google.Chrome --silent --accept-package-agreements --accept-source-agreements
        winget install --id Mozilla.Firefox --silent --accept-package-agreements --accept-source-agreements
        winget install --id Microsoft.VisualStudioCode --silent --accept-package-agreements --accept-source-agreements
        Write-Host "âœ… Software installed"

    - name: Show Connection Info
      run: |
        Write-Host ""
        Write-Host "================================================"
        Write-Host "ğŸ¯ PERMANENT RDP SERVER READY"
        Write-Host "================================================"
        Write-Host "ğŸ”— HOSTNAME: $env:RDP_HOSTNAME"
        Write-Host "ğŸŒ IP: $env:RDP_IP"
        Write-Host "ğŸ‘¤ USERNAME: RDP"
        Write-Host "ğŸ”‘ PASSWORD: Password123!"
        Write-Host "ğŸšª PORTS: 3389, 5555, 7777, 8888, 9999"
        Write-Host "ğŸ’¾ PERSISTENT STORAGE: C:\PersistentData\"
        Write-Host "ğŸ”„ NEW SESSION: All data will be saved"
        Write-Host "================================================"
        Write-Host ""
        Write-Host "ğŸ’¡ CONNECT USING:"
        Write-Host "mstsc /v:$env:RDP_HOSTNAME:3389"
        Write-Host ""
        Write-Host "ğŸ’¡ ALTERNATIVE PORTS:"
        Write-Host "mstsc /v:$env:RDP_HOSTNAME:5555"
        Write-Host "mstsc /v:$env:RDP_HOSTNAME:7777"
        Write-Host "mstsc /v:$env:RDP_HOSTNAME:8888"
        Write-Host "mstsc /v:$env:RDP_HOSTNAME:9999"
        Write-Host ""
        Write-Host "ğŸ”§ DIRECT IP:"
        Write-Host "mstsc /v:$env:RDP_IP:3389"
        Write-Host "================================================"

    - name: Keep Server Running
      run: |
        $count = 0
        Write-Host "ğŸ”„ RDP Server started successfully!"
        Write-Host "ğŸ“¡ Waiting for connections..."
        while ($count -lt 350) {
            $timeLeft = 350 - $count
            Write-Host "[$(Get-Date)] RDP Active - $env:RDP_HOSTNAME - Time left: ${timeLeft}m"
            Start-Sleep -Seconds 60
            $count++
        }
        Write-Host "â° Session completed - All data saved in C:\PersistentData\"
