name: Permanent RDP Server

on:
  workflow_dispatch:

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install Tailscale
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
        Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait
        Start-Sleep -Seconds 10

    - name: Setup Tailscale
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=my-permanent-rdp
        Start-Sleep -Seconds 10
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        $hostname = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json | Select-Object -ExpandProperty Self | Select-Object -ExpandProperty DNSName
        echo "RDP_IP=$ip" >> $env:GITHUB_ENV
        echo "RDP_HOSTNAME=$hostname" >> $env:GITHUB_ENV

    - name: Configure Windows RDP
      run: |
        # ÿ™ŸÅÿπŸäŸÑ RDP ŸÅŸä ÿßŸÑÿ±Ÿäÿ¨ÿ≥ÿ™ÿ±Ÿä
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
        
        # ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÜÿßŸÅÿ∞ ŸÅŸä ÿßŸÑÿ¨ÿØÿßÿ± ÿßŸÑŸÜÿßÿ±Ÿä
        netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389
        netsh advfirewall firewall add rule name="RDP-5555" dir=in action=allow protocol=TCP localport=5555
        netsh advfirewall firewall add rule name="RDP-7777" dir=in action=allow protocol=TCP localport=7777
        netsh advfirewall firewall add rule name="RDP-8888" dir=in action=allow protocol=TCP localport=8888
        netsh advfirewall firewall add rule name="RDP-9999" dir=in action=allow protocol=TCP localport=9999
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿØŸàŸÜ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÖÿπŸÇÿØÿ©
        net user RDP "Password123!" /add /y
        net localgroup administrators RDP /add
        net localgroup "Remote Desktop Users" RDP /add
        
        # ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿÆÿØŸÖÿ© RDP ÿ®ÿØŸàŸÜ ÿ∑ŸÑÿ® ÿ™ÿ£ŸÉŸäÿØ
        Stop-Service -Name "TermService" -Force
        Start-Service -Name "TermService"

    - name: Create Persistent Storage
      run: |
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿØŸäŸÖÿ©
        mkdir C:\PersistentData 2>null
        mkdir C:\PersistentData\Desktop 2>null
        mkdir C:\PersistentData\Documents 2>null
        mkdir C:\PersistentData\Downloads 2>null
        
        # ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ•ÿ∞ÿß ŸÖŸàÿ¨ŸàÿØÿ©
        rmdir "C:\Users\RDP\Desktop" /s /q 2>null
        rmdir "C:\Users\RDP\Documents" /s /q 2>null
        rmdir "C:\Users\RDP\Downloads" /s /q 2>null
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ±Ÿàÿßÿ®ÿ∑ ÿ±ŸÖÿ≤Ÿäÿ©
        mklink /J "C:\Users\RDP\Desktop" "C:\PersistentData\Desktop" 2>null
        mklink /J "C:\Users\RDP\Documents" "C:\PersistentData\Documents" 2>null
        mklink /J "C:\Users\RDP\Downloads" "C:\PersistentData\Downloads" 2>null

    - name: Install Software
      run: |
        # ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ®ÿ±ÿßŸÖÿ¨ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        winget install --id Google.Chrome --silent --accept-package-agreements --accept-source-agreements 2>null
        winget install --id Mozilla.Firefox --silent --accept-package-agreements --accept-source-agreements 2>null
        winget install --id Microsoft.VisualStudioCode --silent --accept-package-agreements --accept-source-agreements 2>null

    - name: Show Connection Info
      run: |
        echo.
        echo "================================================"
        echo "üéØ PERMANENT RDP SERVER READY"
        echo "================================================"
        echo "üîó HOSTNAME: $env:RDP_HOSTNAME"
        echo "üåê IP: $env:RDP_IP"
        echo "üë§ USERNAME: RDP"
        echo "üîë PASSWORD: Password123!"
        echo "üö™ PORTS: 3389, 5555, 7777, 8888, 9999"
        echo "üíæ STORAGE: C:\PersistentData\"
        echo "================================================"
        echo.
        echo "üí° CONNECT USING:"
        echo "mstsc /v:$env:RDP_HOSTNAME:3389"
        echo.
        echo "üí° ALTERNATIVE PORTS:"
        echo "mstsc /v:$env:RDP_HOSTNAME:5555"
        echo "mstsc /v:$env:RDP_HOSTNAME:7777"
        echo "mstsc /v:$env:RDP_HOSTNAME:8888"
        echo "mstsc /v:$env:RDP_HOSTNAME:9999"
        echo.
        echo "üîß DIRECT IP:"
        echo "mstsc /v:$env:RDP_IP:3389"
        echo "================================================"

    - name: Keep Server Running
      run: |
        $count = 0
        while ($count -lt 350) {
            $timeLeft = 350 - $count
            echo "[$(Get-Date)] RDP Server Active - $env:RDP_HOSTNAME - Time left: ${timeLeft}m"
            Start-Sleep -Seconds 60
            $count++
        }
