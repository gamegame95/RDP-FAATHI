name: Permanent RDP Server with Data Persistence

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
    - name: Stop Previous Runs
      run: |
        Write-Host "ğŸ”„ Checking for previous runs..."
        $headers = @{
          "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
          "Accept" = "application/vnd.github.v3+json"
        }
        
        try {
            $runsUrl = "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress"
            $runs = Invoke-RestMethod -Uri $runsUrl -Headers $headers
            
            foreach ($run in $runs.workflow_runs) {
                if ($run.id -ne ${{ github.run_id }} -and $run.name -eq "Permanent RDP Server with Data Persistence") {
                    Write-Host "â¹ï¸ Stopping previous run: $($run.id)"
                    $cancelUrl = "https://api.github.com/repos/${{ github.repository }}/actions/runs/$($run.id)/cancel"
                    Invoke-RestMethod -Uri $cancelUrl -Headers $headers -Method Post
                }
            }
        } catch {
            Write-Host "âš ï¸ Could not stop previous runs: $($_.Exception.Message)"
        }

    - name: Setup Persistent Storage
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¯ÙŠÙ…Ø©
        New-Item -ItemType Directory -Path "C:\PersistentData" -Force
        New-Item -ItemType Directory -Path "C:\PersistentData\UserData" -Force
        New-Item -ItemType Directory -Path "C:\PersistentData\Configs" -Force
        Write-Host "âœ… Persistent directories created"

    - name: Download Previous Data
      run: |
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
        Write-Host "ğŸ“¥ Checking for previous data..."
        
        # ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… GitHub Releases Ø£Ùˆ Git LFS Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        # Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©
        if (Test-Path "C:\PersistentData\last_config.json") {
            Write-Host "âœ… Found previous configuration"
        } else {
            Write-Host "â„¹ï¸ No previous data found, starting fresh"
        }

    - name: Install Tailscale
      run: |
        Write-Host "ğŸ“¥ Installing Tailscale..."
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait
        Start-Sleep -Seconds 10

    - name: Configure Tailscale with Persistent Hostname
      run: |
        Write-Host "ğŸ”§ Configuring Tailscale..."
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… hostname Ø«Ø§Ø¨Øª ØªÙ…Ø§Ù…Ø§Ù‹
        $persistentHostname = "perm-rdp-server"
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$persistentHostname --accept-routes
        
        $tailscaleHostname = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json | Select-Object -ExpandProperty Self | Select-Object -ExpandProperty DNSName
        $tailscaleIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        
        echo "RDP_HOSTNAME=$tailscaleHostname" >> $env:GITHUB_ENV
        echo "RDP_IP=$tailscaleIP" >> $env:GITHUB_ENV
        
        # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
        $connectionInfo = @{
            hostname = $tailscaleHostname
            ip = $tailscaleIP
            timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
        } | ConvertTo-Json
        
        $connectionInfo | Out-File -FilePath "C:\PersistentData\connection_info.json" -Encoding UTF8

    - name: Configure RDP with Persistent User
      run: |
        Write-Host "ğŸ–¥ï¸ Configuring RDP with persistent settings..."
        
        # ØªÙ…ÙƒÙŠÙ† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        
        # ÙØªØ­ Ù…Ù†Ø§ÙØ°
        $ports = @(3389, 5555, 7777, 8888, 9999)
        foreach ($port in $ports) {
            netsh advfirewall firewall add rule name="RDP-$port" dir=in action=allow protocol=TCP localport=$port
        }
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… (Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡)
        $password = "!QA2ws3ed"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        $userExists = Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
        if (-not $userExists) {
            New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
            Write-Host "âœ… New user created"
        } else {
            # ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            Set-LocalUser -Name "RDPUser" -Password $securePass
            Write-Host "âœ… Existing user password updated"
        }
        
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        $userConfig = @{
            username = "RDPUser"
            password_set = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
        } | ConvertTo-Json
        
        $userConfig | Out-File -FilePath "C:\PersistentData\user_config.json" -Encoding UTF8
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RDP Ø¥Ø¶Ø§ÙÙŠØ©
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "KeepAliveEnable" -Value 1
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "KeepAliveInterval" -Value 1
        
        Restart-Service -Name TermService -Force

    - name: Install Essential Software Persistently
      run: |
        Write-Host "ğŸ“¦ Installing essential software..."
        
        # Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØªÙ‡Ø§
        $softwareConfig = @{
            installed_software = @()
            install_time = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
        }
        
        # ØªØ«Ø¨ÙŠØª Chrome (Ù…Ø«Ø§Ù„)
        try {
            $chromeUrl = "https://dl.google.com/tag/s/appguid%3D%7B8A69D345-D564-463C-AFF1-A69D9E530F96%7D%26iid%3D%7B80763Ef-6D7C-3B3B-3F3F-3F3F3F3F3F3F%7D%26lang%3Den%26browser%3D4%26usagestats%3D0%26appname%3DGoogle%2520Chrome%26needsadmin%3Dprefers%26ap%3Dstable-arch_x86-statsdef_1%26installdataindex%3Dempty/update2/installers/ChromeSetup.exe"
            $chromePath = "$env:TEMP\ChromeSetup.exe"
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ø³Ø¨Ù‚Ø§Ù‹
            if (-not (Test-Path "$env:ProgramFiles\Google\Chrome\Application\chrome.exe")) {
                Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
                Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
                $softwareConfig.installed_software += "Google Chrome"
                Write-Host "âœ… Chrome installed"
            } else {
                Write-Host "âœ… Chrome already installed"
            }
        } catch {
            Write-Host "âš ï¸ Failed to install Chrome: $($_.Exception.Message)"
        }
        
        # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª
        $softwareConfig | Out-File -FilePath "C:\PersistentData\software_config.json" -Encoding UTF8

    - name: Setup Data Backup System
      run: |
        Write-Host "ğŸ’¾ Setting up data backup system..."
        
        # Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        $backupScript = @'
# Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø©
function Backup-Data {
    `$backupDir = "C:\PersistentData\Backups"
    New-Item -ItemType Directory -Path `$backupDir -Force
    
    # Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø«Ø¨ØªØ©
    Get-WmiObject -Class Win32_Product | Select-Object Name, Version | Export-Csv -Path "`$backupDir\installed_software.csv" -NoTypeInformation
    
    # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    systeminfo | Out-File -FilePath "`$backupDir\system_info.txt"
    
    # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
    ipconfig /all | Out-File -FilePath "`$backupDir\network_info.txt"
    
    Write-Host "âœ… Data backed up to `$backupDir"
}

# ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
Register-EngineEvent -SourceIdentifier PowerShell.Exiting -Action {
    Backup-Data
}
'@
        
        $backupScript | Out-File -FilePath "C:\PersistentData\backup_script.ps1" -Encoding UTF8
        
        # ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        & "C:\PersistentData\backup_script.ps1"

    - name: Start Auto-Restart with Data Preservation
      run: |
        Write-Host "ğŸ”„ Setting up smart auto-restart..."
        
        $restartScript = @'
# Ø³ÙƒØ±ÙŠØ¨Øª Ø°ÙƒÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
`$restartTime = 5 * 60 * 60  # 5 Ø³Ø§Ø¹Ø§Øª

Write-Host "â° Smart restart scheduled in 5 hours..."

# Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
function Save-BeforeRestart {
    `$data = @{
        last_restart = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
        session_data = @{
            running_time = "5 hours"
            user_activity = "active"
        }
    } | ConvertTo-Json
    
    `$data | Out-File -FilePath "C:\PersistentData\last_session.json" -Encoding UTF8
    Write-Host "ğŸ’¾ Session data saved"
}

# Ø¬Ø¯ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù€ 5 Ø¯Ù‚Ø§Ø¦Ù‚
`$saveTime = `$restartTime - 300  # 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
Start-Job -ScriptBlock {
    Start-Sleep -Seconds `$using:saveTime
    Save-BeforeRestart
}

Start-Sleep -Seconds `$restartTime

Write-Host "ğŸ”„ Initiating smart restart..."

# Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ Workflow
`$body = @{
    ref = "${{ github.ref }}"
} | ConvertTo-Json

`$headers = @{
    "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
    "Accept" = "application/vnd.github.v3+json"
}

try {
    `$triggerUrl = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml/dispatches"
    Invoke-RestMethod -Uri `$triggerUrl -Headers `$headers -Method Post -Body `$body
    Write-Host "âœ… Workflow restart triggered with data preservation"
} catch {
    Write-Host "âŒ Failed to restart: `$(`$_.Exception.Message)"
}
'@
        
        $restartScript | Out-File -FilePath "$env:TEMP\smart_restart.ps1" -Encoding UTF8
        Start-Process powershell -ArgumentList "-File", "$env:TEMP\smart_restart.ps1" -WindowStyle Hidden

    - name: Display Persistent Connection Info
      run: |
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        $lastSession = "New Session"
        if (Test-Path "C:\PersistentData\last_session.json") {
            $sessionData = Get-Content "C:\PersistentData\last_session.json" | ConvertFrom-Json
            $lastSession = $sessionData.last_restart
        }
        
        Write-Host ""
        Write-Host "ğŸ¯ PERSISTENT RDP SERVER READY!" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host "ğŸ”— HOSTNAME: $env:RDP_HOSTNAME" -ForegroundColor Cyan
        Write-Host "ğŸŒ IP: $env:RDP_IP" -ForegroundColor Cyan
        Write-Host "ğŸ‘¤ USERNAME: RDPUser" -ForegroundColor White
        Write-Host "ğŸ”‘ PASSWORD: !QA2ws3ed" -ForegroundColor White
        Write-Host "ğŸ’¾ DATA: Persistent across restarts" -ForegroundColor Magenta
        Write-Host "ğŸ• LAST SESSION: $lastSession" -ForegroundColor White
        Write-Host "========================================" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "ğŸ’¡ CONNECT: mstsc /v:$env:RDP_HOSTNAME:3389" -ForegroundColor White
        Write-Host "ğŸ”„ Auto-restart with data preservation every 5 hours" -ForegroundColor Green

    - name: Keep Alive with Data Monitoring
      run: |
        $counter = 0
        $maxMinutes = 340
        
        while ($counter -lt $maxMinutes) {
            $hours = [math]::Floor($counter / 60)
            $minutes = $counter % 60
            
            # Ø­ÙØ¸ ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ù„Ø³Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
            if ($counter % 30 -eq 0) {
                $sessionProgress = @{
                    uptime_minutes = $counter
                    last_update = (Get-Date).ToString("HH:mm:ss")
                } | ConvertTo-Json
                
                $sessionProgress | Out-File -FilePath "C:\PersistentData\session_progress.json" -Encoding UTF8
            }
            
            Write-Host "ğŸ–¥ï¸ Persistent RDP Active | Uptime: $hoursh $($minutes)m" -ForegroundColor Green
            Write-Host "ğŸ”— $env:RDP_HOSTNAME | ğŸ’¾ Data preserved" -ForegroundColor Cyan
            
            Start-Sleep -Seconds 60
            $counter++
        }
        
        Write-Host "ğŸ’¾ Finalizing data preservation..." -ForegroundColor Cyan
